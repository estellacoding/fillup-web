# 需求文件

## 簡介

目標與設定功能讓使用者能夠個人化其飲水追蹤體驗，包括設定每日飲水目標、活躍時段、偏好的計量單位，以及快速輸入預設值。此功能是計算進度率、提供節奏提醒，以及在整個應用程式中提供個人化回饋的基礎。

## 術語表

- **系統**：FillUp! 飲水追蹤應用程式
- **使用者**：使用應用程式追蹤飲水量的個人
- **每日目標**：使用者每天希望攝取的目標水量（以 ml 為單位）
- **活躍時段**：使用者打算追蹤飲水的時間範圍（例如：09:00-18:00）
- **單位系統**：顯示水量的計量系統（毫升或液體盎司）
- **預設容量**：用於快速記錄飲水量的預先設定容量按鈕（例如：250ml、350ml、500ml）
- **完成率**：當前時間已達成每日目標的百分比
- **節奏指標**：顯示使用者是否按進度、超前或落後的視覺或文字回饋
- **設定儲存庫**：用於使用者偏好設定的 Zustand 狀態管理儲存庫
- **正規化**：無論顯示單位為何，將所有內部計算轉換為毫升的過程

## 需求

### 需求 1

**使用者故事：** 作為使用者，我想要設定每日飲水目標，以便追蹤我朝向個人化飲水目標的進度。

#### 驗收標準

1. WHEN 使用者進入設定頁面 THEN 系統 SHALL 以使用者偏好的單位顯示當前每日目標
2. WHEN 使用者修改每日目標值 THEN 系統 SHALL 驗證該值介於 500ml 至 5000ml 之間
3. WHEN 使用者儲存有效的每日目標 THEN 系統 SHALL 將目標持久化至後端並立即更新設定儲存庫
4. WHEN 每日目標更新後 THEN 系統 SHALL 在主頁面重新計算完成率，無需重新整理頁面
5. WHEN 使用者輸入無效的目標值 THEN 系統 SHALL 顯示錯誤訊息並阻止儲存

### 需求 2

**使用者故事：** 作為使用者，我想要定義我的活躍飲水追蹤時段，以便系統能在我清醒的時間提供相關的進度回饋。

#### 驗收標準

1. WHEN 使用者進入設定頁面 THEN 系統 SHALL 顯示當前活躍時段的開始和結束時間
2. WHEN 使用者選擇開始時間 THEN 系統 SHALL 驗證開始時間早於結束時間
3. WHEN 使用者選擇結束時間 THEN 系統 SHALL 驗證結束時間晚於開始時間且在同一個 24 小時週期內
4. WHEN 使用者儲存有效的活躍時段 THEN 系統 SHALL 將時間持久化至後端並立即更新設定儲存庫
5. WHEN 活躍時段更新後 THEN 系統 SHALL 根據新的時間範圍在主頁面重新計算節奏指標

### 需求 3

**使用者故事：** 作為使用者，我想要在毫升和液體盎司之間切換，以便以我偏好的計量系統檢視飲水量。

#### 驗收標準

1. WHEN 使用者進入設定頁面 THEN 系統 SHALL 顯示當前單位偏好（ml 或 oz）
2. WHEN 使用者切換單位偏好 THEN 系統 SHALL 立即將所有顯示值轉換為所選單位
3. WHEN 單位偏好改變時 THEN 系統 SHALL 維持所有內部計算使用毫升以確保資料一致性
4. WHEN 使用者儲存單位偏好 THEN 系統 SHALL 將偏好持久化至後端並立即更新設定儲存庫
5. WHEN 單位偏好更新後 THEN 系統 SHALL 更新整個應用程式中的所有容量顯示且不遺失資料

### 需求 4

**使用者故事：** 作為使用者，我想要自訂快速輸入的預設容量，以便使用符合我實際飲水容器的按鈕記錄飲水量。

#### 驗收標準

1. WHEN 使用者進入設定頁面 THEN 系統 SHALL 以使用者偏好的單位顯示當前預設容量
2. WHEN 使用者修改預設容量 THEN 系統 SHALL 驗證該值介於 50ml 至 2000ml 之間
3. WHEN 使用者新增預設值 THEN 系統 SHALL 允許最多 5 個預設容量
4. WHEN 使用者移除預設值 THEN 系統 SHALL 維持至少 1 個預設容量
5. WHEN 使用者儲存預設值變更 THEN 系統 SHALL 將預設值以 JSON 陣列形式持久化至後端並立即更新設定儲存庫
6. WHEN 預設容量更新後 THEN 系統 SHALL 更新主頁面的快速輸入按鈕，無需重新整理頁面

### 需求 5

**使用者故事：** 作為使用者，我想要在主頁面看到我的飲水進度和節奏回饋，以便知道我是否按進度達成每日目標。

#### 驗收標準

1. WHEN 使用者檢視主頁面 THEN 系統 SHALL 根據當前攝取量和每日目標顯示完成率百分比
2. WHEN 當前時間在活躍時段內 THEN 系統 SHALL 根據已過時間計算預期進度
3. WHEN 當前攝取量超過預期進度 THEN 系統 SHALL 顯示正面節奏指標（例如：「超前進度」）
4. WHEN 當前攝取量低於預期進度 THEN 系統 SHALL 顯示負面節奏指標（例如：「落後進度」）
5. WHEN 當前時間在活躍時段外 THEN 系統 SHALL 僅顯示完成率而不顯示節奏回饋

### 需求 6

**使用者故事：** 作為開發者，我想要一個集中式的設定狀態管理解決方案，以便設定變更能一致地傳播到所有元件。

#### 驗收標準

1. WHEN 應用程式初始化時 THEN 系統 SHALL 從後端載入使用者設定至設定儲存庫
2. WHEN 設定更新時 THEN 系統 SHALL 在進行 API 呼叫前更新設定儲存庫
3. WHEN API 呼叫失敗時 THEN 系統 SHALL 將設定儲存庫還原至先前狀態並顯示錯誤訊息
4. WHEN 多個元件訂閱設定時 THEN 系統 SHALL 立即通知所有訂閱者狀態變更
5. WHEN 設定持久化時 THEN 系統 SHALL 儲存最後更新的時間戳記

### 需求 7

**使用者故事：** 作為開發者，我想要一個單位轉換工具模組，以便在整個應用程式中一致地在毫升和液體盎司之間轉換。

#### 驗收標準

1. WHEN 從毫升轉換為液體盎司時 THEN 系統 SHALL 使用轉換係數 1 oz = 29.5735 ml
2. WHEN 從液體盎司轉換為毫升時 THEN 系統 SHALL 使用轉換係數 1 oz = 29.5735 ml
3. WHEN 顯示轉換值時 THEN 系統 SHALL 將液體盎司四捨五入至小數點後 1 位
4. WHEN 執行內部計算時 THEN 系統 SHALL 始終使用毫升作為正規化單位
5. WHEN 轉換值時 THEN 系統 SHALL 妥善處理零和負值等邊界情況

### 需求 8

**使用者故事：** 作為系統管理員，我想要一個用於管理使用者目標和設定的後端 API，以便使用者偏好能在不同工作階段和裝置間持久保存。

#### 驗收標準

1. WHEN 對 /api/goals 發出 GET 請求時 THEN 系統 SHALL 回傳使用者當前的目標設定，包括 daily_goal_ml、active_from、active_to 和 presets_json
2. WHEN 對 /api/goals 發出包含有效資料的 PUT 請求時 THEN 系統 SHALL 更新目標記錄並回傳更新後的設定
3. WHEN PUT 請求包含無效資料時 THEN 系統 SHALL 回傳 422 狀態碼及驗證錯誤詳情
4. WHEN 目標設定更新時 THEN 系統 SHALL 驗證 active_from 早於 active_to
5. WHEN 目標設定被檢索或更新時 THEN 系統 SHALL 透過對照 schema 約束驗證所有欄位以確保資料完整性

### 需求 9

**使用者故事：** 作為品質保證工程師，我想要針對設定功能進行全面測試，以便驗證單位轉換和狀態同步的正確行為。

#### 驗收標準

1. WHEN 執行單元測試時 THEN 系統 SHALL 驗證單位轉換函式產生的結果在 0.01ml 容差範圍內準確
2. WHEN 執行單元測試時 THEN 系統 SHALL 驗證變更顯示單位不會影響內部毫升正規化
3. WHEN 執行整合測試時 THEN 系統 SHALL 驗證透過設定頁面更新設定會立即反映在主頁面
4. WHEN 執行整合測試時 THEN 系統 SHALL 驗證 API 失敗時會正確還原設定儲存庫的狀態變更
5. WHEN 執行端對端測試時 THEN 系統 SHALL 驗證從設定頁面修改到主頁面節奏指標更新的完整流程
