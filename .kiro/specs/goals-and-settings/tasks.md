# 實作計畫

- [x] 1. 建立單位轉換工具模組
  - 實作 ml 到 oz 和 oz 到 ml 的轉換函式
  - 實作格式化和解析函式
  - 處理邊界情況（零、負值）
  - _需求：7.1, 7.2, 7.3, 7.4, 7.5_

- [ ]* 1.1 撰寫單位轉換的屬性測試
  - **屬性 7：單位轉換往返一致性**
  - **屬性 18：單位轉換係數正確性**
  - **驗證：需求 7.1, 7.2, 9.1**

- [ ]* 1.2 撰寫單位轉換的單元測試
  - 測試 ml 到 oz 轉換
  - 測試 oz 到 ml 轉換
  - 測試四捨五入邏輯
  - 測試邊界值
  - _需求：7.1, 7.2, 7.3, 7.5_

- [ ] 2. 建立後端 Goal 資料模型和 Schema
  - 建立 SQLAlchemy Goal 模型（daily_goal_ml, active_from, active_to, presets_json, unit_preference）
  - 建立 Pydantic GoalBase, GoalUpsert, GoalOut schemas
  - 實作欄位驗證器（範圍、時間格式、時間順序）
  - 建立資料庫遷移腳本
  - _需求：8.1, 8.2, 8.3, 8.4, 8.5_

- [ ]* 2.1 撰寫 Schema 驗證的單元測試
  - 測試欄位範圍驗證
  - 測試時間格式驗證
  - 測試時間順序驗證
  - 測試預設值陣列驗證
  - _需求：8.3, 8.4, 8.5_

- [ ] 3. 實作後端 Goals API 路由
  - 實作 GET /api/goals 端點
  - 實作 PUT /api/goals 端點
  - 加入認證和授權檢查
  - 實作錯誤處理和驗證
  - _需求：8.1, 8.2, 8.3, 8.4, 8.5_

- [ ]* 3.1 撰寫 API 路由的屬性測試
  - **屬性 21：API 更新冪等性**
  - **屬性 22：API 驗證錯誤回應**
  - **屬性 23：時間範圍 Schema 驗證**
  - **驗證：需求 8.2, 8.3, 8.4**

- [ ]* 3.2 撰寫 API 路由的單元測試
  - 測試 GET 端點回應格式
  - 測試 PUT 端點更新邏輯
  - 測試錯誤回應（422, 500）
  - 測試認證/授權
  - _需求：8.1, 8.2, 8.3_

- [ ] 4. 建立前端 goals service
  - 實作 fetchGoals() 函式
  - 實作 updateGoals() 函式
  - 加入錯誤處理和重試邏輯
  - 設定 HTTP 客戶端（axios/fetch）
  - _需求：6.1, 6.3_

- [ ] 5. 建立 Zustand useSettingsStore
  - 定義狀態結構（dailyGoalMl, activeFrom, activeTo, unitPreference, presets）
  - 實作 fetchGoals action
  - 實作 updateGoals action（樂觀更新 + 錯誤還原）
  - 實作 setUnitPreference action
  - 實作輔助方法（getDisplayValue, getNormalizedValue）
  - _需求：6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 5.1 撰寫 useSettingsStore 的單元測試
  - 測試初始狀態
  - 測試 action 函式
  - 測試樂觀更新邏輯
  - 測試錯誤還原邏輯
  - 測試輔助方法
  - _需求：6.1, 6.2, 6.3, 6.4_

- [ ]* 5.2 撰寫狀態管理的屬性測試
  - **屬性 15：樂觀更新順序**
  - **屬性 16：API 失敗狀態還原**
  - **屬性 17：訂閱者通知即時性**
  - **驗證：需求 6.2, 6.3, 6.4**

- [ ] 6. 實作進度計算邏輯
  - 建立 calculateProgress 函式（完成率、預期進度、節奏狀態）
  - 處理活躍時段內外的不同邏輯
  - 實作節奏狀態判斷（ahead, on-track, behind, inactive）
  - _需求：5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 6.1 撰寫進度計算的屬性測試
  - **屬性 11：完成率計算正確性**
  - **屬性 12：預期進度計算正確性**
  - **屬性 13：節奏指標狀態正確性**
  - **屬性 14：時段外節奏指標隱藏**
  - **驗證：需求 5.1, 5.2, 5.3, 5.4, 5.5**

- [ ]* 6.2 撰寫進度計算的單元測試
  - 測試完成率計算
  - 測試預期進度計算
  - 測試節奏狀態判斷
  - 測試邊界情況
  - _需求：5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 7. 建立 Settings 頁面 UI
  - 建立頁面結構和佈局
  - 實作每日目標輸入欄位（含驗證）
  - 實作活躍時段時間選擇器（含驗證）
  - 實作單位切換開關
  - 實作預設容量管理（新增/編輯/刪除）
  - 整合 useSettingsStore
  - 實作表單提交和錯誤處理
  - _需求：1.1, 1.2, 1.5, 2.1, 2.2, 2.3, 3.1, 3.2, 4.1, 4.2, 4.3, 4.4_

- [ ]* 7.1 撰寫 Settings 頁面的單元測試
  - 測試表單驗證
  - 測試使用者互動
  - 測試錯誤顯示
  - _需求：1.2, 1.5, 2.2, 2.3, 4.2, 4.3, 4.4_

- [ ] 8. 增強 Home 頁面以顯示進度和節奏
  - 從 useSettingsStore 訂閱設定
  - 整合 calculateProgress 函式
  - 顯示完成率百分比
  - 顯示節奏指標和訊息
  - 確保設定變更時即時更新
  - _需求：1.4, 2.5, 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 8.1 撰寫 Home 頁面增強的單元測試
  - 測試進度顯示
  - 測試節奏指標顯示
  - 測試設定變更反應
  - _需求：1.4, 2.5, 5.1, 5.3, 5.4, 5.5_

- [ ] 9. 更新 QuickInputButtons 元件
  - 從 useSettingsStore 讀取預設容量
  - 根據 unitPreference 顯示按鈕標籤
  - 點擊時轉換為 ml 並記錄
  - 確保預設值變更時即時更新按鈕
  - _需求：4.6_

- [ ]* 9.1 撰寫 QuickInputButtons 的單元測試
  - 測試按鈕渲染
  - 測試單位顯示
  - 測試點擊行為
  - 測試預設值變更反應
  - _需求：4.6_

- [ ] 10. 實作單位切換功能
  - 在 Settings 頁面實作單位切換 UI
  - 確保切換時所有顯示值立即轉換
  - 驗證內部資料保持 ml 格式
  - 更新所有相關元件（Home, QuickInputButtons）
  - _需求：3.2, 3.3, 3.4, 3.5_

- [ ]* 10.1 撰寫單位切換的屬性測試
  - **屬性 5：單位轉換即時性**
  - **屬性 6：內部資料正規化不變性**
  - **驗證：需求 3.2, 3.3, 9.2**

- [ ]* 10.2 撰寫單位切換的整合測試
  - 測試切換後所有顯示值更新
  - 測試內部資料不變
  - 測試多次切換無資料損失
  - _需求：3.2, 3.3, 3.5, 9.2_

- [ ] 11. 檢查點 - 確保所有測試通過
  - 確保所有測試通過，如有問題請詢問使用者

- [ ]* 12. 撰寫整合測試
  - 測試前後端整合（Settings → API → 資料庫）
  - 測試 API 失敗時的狀態還原
  - 測試 Settings 更新後 Home 立即反映
  - 測試 store 變更通知所有訂閱元件
  - _需求：1.3, 1.4, 2.4, 2.5, 3.4, 4.5, 4.6, 6.3, 6.4, 9.3, 9.4_

- [ ]* 13. 撰寫端對端測試
  - 測試設定目標完整流程
  - 測試單位切換完整流程
  - 測試預設容量管理完整流程
  - 測試錯誤處理流程
  - _需求：9.5_

- [ ] 14. 最終檢查點 - 確保所有測試通過
  - 確保所有測試通過，如有問題請詢問使用者
